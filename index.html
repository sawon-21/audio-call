<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Audio Call with Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      background: #0b1e2d;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .call-box {
      background: #1f2a3a;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      text-align: center;
    }
    video, audio {
      display: none;
    }
  </style>
</head>
<body>

<div class="call-box" id="callBox" style="display:none;">
  <h3>Calling Admin: Mehedi Al Hasan Sawon</h3>
  <button class="btn btn-danger mt-3" onclick="endCall()">End Call</button>
</div>

<div id="loginBox">
  <h2>Welcome to Audio Call</h2>
  <button class="btn btn-primary" onclick="login()">Continue with Google</button>
</div>

<!-- Modal for Name and Phone -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="infoForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Your Info</h5>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control mb-2" placeholder="Your Name" id="nameInput" required />
        <input type="text" class="form-control" placeholder="Phone Number" id="phoneInput" required />
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Start Call</button>
      </div>
    </form>
  </div>
</div>

<!-- Audio elements -->
<audio id="localAudio" autoplay muted></audio>
<audio id="remoteAudio" autoplay></audio>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyB4CQ3uiTxrvmbbXM01vcB_LjeW7Lk6ogI",
    authDomain: "adui-3ee05.firebaseapp.com",
    projectId: "adui-3ee05",
    storageBucket: "adui-3ee05.appspot.com",
    messagingSenderId: "766920897994",
    appId: "1:766920897994:web:0cea7f8c206455749bcb33",
    databaseURL: "https://adui-3ee05-default-rtdb.firebaseio.com/"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let user = null;
  let localStream;
  let peerConnection;
  const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

  function login() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then(result => {
        user = result.user;
        const userId = user.uid;
        // Check if user has name/phone stored
        db.ref('users/' + userId).once('value').then(snapshot => {
          if (!snapshot.exists()) {
            new bootstrap.Modal(document.getElementById('infoModal')).show();
          } else {
            startCall();
          }
        });
      })
      .catch(console.error);
  }

  document.getElementById('infoForm').addEventListener('submit', e => {
    e.preventDefault();
    const name = document.getElementById('nameInput').value;
    const phone = document.getElementById('phoneInput').value;
    db.ref('users/' + user.uid).set({ name, phone }).then(() => {
      bootstrap.Modal.getInstance(document.getElementById('infoModal')).hide();
      startCall();
    });
  });

  async function startCall() {
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('callBox').style.display = 'block';

    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    document.getElementById('localAudio').srcObject = localStream;

    peerConnection = new RTCPeerConnection(servers);
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.ontrack = event => {
      document.getElementById('remoteAudio').srcObject = event.streams[0];
    };

    const callRef = db.ref('calls/' + user.uid);
    peerConnection.onicecandidate = e => {
      if (e.candidate) {
        callRef.child('callerCandidates').push(JSON.stringify(e.candidate));
      }
    };

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    callRef.set({ offer });

    // Listen for answer
    callRef.on('value', async snapshot => {
      const data = snapshot.val();
      if (data?.answer && !peerConnection.currentRemoteDescription) {
        const answer = new RTCSessionDescription(data.answer);
        await peerConnection.setRemoteDescription(answer);
      }
    });

    // Listen for ICE from admin
    db.ref('calls/' + user.uid + '/calleeCandidates').on('child_added', snapshot => {
      const candidate = new RTCIceCandidate(JSON.parse(snapshot.val()));
      peerConnection.addIceCandidate(candidate);
    });
  }

  function endCall() {
    peerConnection?.close();
    db.ref('calls/' + user.uid).remove();
    alert('Call ended');
    window.location.reload();
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>