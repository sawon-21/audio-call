<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HD Video Call</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary: #6366f1;
      --danger: #ef4444;
      --success: #10b981;
      --dark: #1e293b;
      --light: #f8fafc;
      --overlay: rgba(0, 0, 0, 0.7);
      --glass: rgba(255, 255, 255, 0.15);
    }
    
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      font-family: 'Segoe UI', system-ui, sans-serif;
      color: var(--light);
      overflow: hidden;
    }
    
    .video-container {
      position: relative;
      width: 100%;
      height: 100%;
    }
    
    #remoteVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
    }
    
    #localVideo {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 120px;
      height: 170px;
      border-radius: 12px;
      border: 2px solid var(--light);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      object-fit: cover;
      z-index: 2;
      transition: all 0.3s ease;
    }
    
    #localVideo:hover {
      transform: scale(1.05);
    }
    
    .call-header {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      padding: 15px;
      z-index: 3;
      display: flex;
      justify-content: space-between;
    }
    
    .call-info {
      position: absolute;
      top: 70px;
      left: 0;
      width: 100%;
      text-align: center;
      z-index: 3;
    }
    
    .call-info h4 {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 5px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    .call-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--overlay);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    .status-idle { background: #64748b; }
    .status-connecting { background: #f59e0b; animation: pulse 1.5s infinite; }
    .status-active { background: #10b981; }
    .status-error { background: var(--danger); }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .call-controls {
      position: absolute;
      bottom: 30px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 15px;
      z-index: 4;
    }
    
    .control-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      font-size: 1.3rem;
      color: white;
      background: var(--glass);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    .control-btn:hover {
      transform: scale(1.1);
    }
    
    .control-btn:active {
      transform: scale(0.95);
    }
    
    .control-btn.end-call {
      background: var(--danger);
    }
    
    .control-btn.screen-share {
      background: var(--success);
    }
    
    .modal-content {
      background: var(--dark);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
    }
    
    .form-control {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
    }
    
    .form-control:focus {
      background: rgba(0,0,0,0.5);
      border-color: var(--primary);
      color: white;
      box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.25);
    }
    
    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
    }
    
    .toast {
      background: var(--dark);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      #localVideo {
        width: 100px;
        height: 140px;
      }
      
      .call-controls {
        bottom: 20px;
        gap: 12px;
      }
      
      .control-btn {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
      }
      
      .call-info h4 {
        font-size: 1.2rem;
      }
    }
    
    @media (max-width: 480px) {
      #localVideo {
        width: 80px;
        height: 120px;
        top: 10px;
        right: 10px;
      }
      
      .call-controls {
        bottom: 15px;
        gap: 10px;
      }
      
      .control-btn {
        width: 45px;
        height: 45px;
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <div class="video-container">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
    
    <div class="call-header">
      <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#roomModal">
        <i class="bi bi-people me-1"></i> Room
      </button>
    </div>
    
    <div class="call-info">
      <h4 id="userName">Guest</h4>
      <div class="call-status">
        <span class="status-dot status-idle"></span>
        <span id="statusText">Idle</span>
      </div>
    </div>
    
    <div class="call-controls">
      <button id="muteBtn" class="control-btn" title="Mute">
        <i class="bi bi-mic-fill"></i>
      </button>
      <button id="endCallBtn" class="control-btn end-call" title="End Call">
        <i class="bi bi-telephone-x-fill"></i>
      </button>
      <button id="videoBtn" class="control-btn" title="Turn Off Video">
        <i class="bi bi-camera-video-fill"></i>
      </button>
      <button id="screenBtn" class="control-btn screen-share" title="Share Screen">
        <i class="bi bi-laptop"></i>
      </button>
    </div>
  </div>
  
  <!-- Room Modal -->
  <div class="modal fade" id="roomModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Join or Create Room</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="nameInput" class="form-label">Your Name</label>
            <input type="text" class="form-control" id="nameInput" placeholder="Enter your name">
          </div>
          <div class="mb-3">
            <label for="roomInput" class="form-label">Room ID</label>
            <input type="text" class="form-control" id="roomInput" placeholder="Enter room ID">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" id="createBtn" class="btn btn-primary">Create Room</button>
          <button type="button" id="joinBtn" class="btn btn-success">Join Room</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMessage"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB4CQ3uiTxrvmbbXM01vcB_LjeW7Lk6ogI",
      authDomain: "adui-3ee05.firebaseapp.com",
      projectId: "adui-3ee05",
      storageBucket: "adui-3ee05.appspot.com",
      messagingSenderId: "766920897994",
      appId: "1:766920897994:web:0cea7f8c206455749bcb33",
      databaseURL: "https://adui-3ee05-default-rtdb.firebaseio.com/"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // DOM Elements
    const remoteVideo = document.getElementById('remoteVideo');
    const localVideo = document.getElementById('localVideo');
    const userNameDisplay = document.getElementById('userName');
    const statusText = document.getElementById('statusText');
    const statusDot = document.querySelector('.status-dot');
    const muteBtn = document.getElementById('muteBtn');
    const endCallBtn = document.getElementById('endCallBtn');
    const videoBtn = document.getElementById('videoBtn');
    const screenBtn = document.getElementById('screenBtn');
    const nameInput = document.getElementById('nameInput');
    const roomInput = document.getElementById('roomInput');
    const createBtn = document.getElementById('createBtn');
    const joinBtn = document.getElementById('joinBtn');
    const toast = new bootstrap.Toast(document.getElementById('toast'));
    const toastMessage = document.getElementById('toastMessage');
    const roomModal = new bootstrap.Modal(document.getElementById('roomModal'));

    // Variables
    let localStream;
    let peerConnection;
    let screenStream;
    let currentRoomId = '';
    let isMuted = false;
    let isVideoOff = false;
    let isScreenSharing = false;
    let currentUserName = '';

    // ICE Servers Configuration
    const pcConfig = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' }
      ]
    };

    // Initialize the app
    init();

    function init() {
      setupEventListeners();
      checkPermissions();
    }

    function setupEventListeners() {
      // Control buttons
      muteBtn.addEventListener('click', toggleMute);
      endCallBtn.addEventListener('click', endCall);
      videoBtn.addEventListener('click', toggleVideo);
      screenBtn.addEventListener('click', toggleScreenShare);
      
      // Room buttons
      createBtn.addEventListener('click', () => startCall(true));
      joinBtn.addEventListener('click', () => startCall(false));
      
      // Before unload cleanup
      window.addEventListener('beforeunload', cleanup);
    }

    async function checkPermissions() {
      try {
        // Check if we already have permissions
        const devices = await navigator.mediaDevices.enumerateDevices();
        const hasVideoPermission = devices.some(device => device.kind === 'videoinput' && device.label);
        const hasAudioPermission = devices.some(device => device.kind === 'audioinput' && device.label);
        
        if (!hasVideoPermission || !hasAudioPermission) {
          showToast('Please allow camera and microphone access');
        }
      } catch (error) {
        console.error('Error checking permissions:', error);
      }
    }

    async function startCall(isCreator) {
      currentUserName = nameInput.value.trim();
      const roomId = roomInput.value.trim();
      
      if (!currentUserName) {
        showToast('Please enter your name');
        return;
      }
      
      if (!roomId) {
        showToast('Please enter a room ID');
        return;
      }
      
      currentRoomId = roomId;
      userNameDisplay.textContent = currentUserName;
      roomModal.hide();
      
      try {
        // Get user media with HD quality
        localStream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            frameRate: { ideal: 30 }
          },
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        });
        
        localVideo.srcObject = localStream;
        updateStatus(isCreator ? 'Creating room...' : 'Joining room...', 'status-connecting');
        
        // Create peer connection
        peerConnection = new RTCPeerConnection(pcConfig);
        
        // Add local stream tracks
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });
        
        // Remote stream handler
        peerConnection.ontrack = event => {
          if (!remoteVideo.srcObject) {
            remoteVideo.srcObject = event.streams[0];
            updateStatus('In call', 'status-active');
            showToast('Call connected');
          }
        };
        
        // ICE candidate handler
        peerConnection.onicecandidate = event => {
          if (event.candidate) {
            database.ref(`calls/${roomId}/ice`).push(JSON.stringify(event.candidate));
          }
        };
        
        // ICE connection state handler
        peerConnection.oniceconnectionstatechange = () => {
          if (peerConnection.iceConnectionState === 'disconnected') {
            updateStatus('Disconnected', 'status-error');
            showToast('Connection lost');
          }
        };
        
        const roomRef = database.ref(`calls/${roomId}`);
        
        if (isCreator) {
          // Create offer
          const offer = await peerConnection.createOffer({
            offerToReceiveAudio: true,
            offerToReceiveVideo: true
          });
          
          await peerConnection.setLocalDescription(offer);
          
          // Save offer to database
          await roomRef.child('offer').set(JSON.stringify(offer));
          
          // Listen for answer
          roomRef.child('answer').on('value', async snap => {
            if (snap.exists()) {
              const answer = JSON.parse(snap.val());
              await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            }
          });
          
          // Cleanup after 1 hour
          setTimeout(() => roomRef.remove(), 3600000);
        } else {
          // Get offer from database
          const offerSnap = await roomRef.child('offer').get();
          if (!offerSnap.exists()) {
            updateStatus('Room not found', 'status-error');
            showToast('Room not found');
            return;
          }
          
          const offer = JSON.parse(offerSnap.val());
          await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
          
          // Create answer
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          
          // Save answer to database
          await roomRef.child('answer').set(JSON.stringify(answer));
        }
        
        // Listen for ICE candidates
        roomRef.child('ice').on('child_added', snap => {
          const candidate = JSON.parse(snap.val());
          peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        });
        
      } catch (error) {
        console.error('Call setup error:', error);
        updateStatus('Error', 'status-error');
        showToast('Error setting up call: ' + error.message);
        cleanup();
      }
    }

    function toggleMute() {
      if (!localStream) return;
      
      isMuted = !isMuted;
      localStream.getAudioTracks()[0].enabled = !isMuted;
      muteBtn.innerHTML = isMuted ? '<i class="bi bi-mic-mute-fill"></i>' : '<i class="bi bi-mic-fill"></i>';
      muteBtn.title = isMuted ? 'Unmute' : 'Mute';
      showToast(isMuted ? 'Microphone muted' : 'Microphone unmuted');
    }

    function toggleVideo() {
      if (!localStream) return;
      
      isVideoOff = !isVideoOff;
      localStream.getVideoTracks()[0].enabled = !isVideoOff;
      videoBtn.innerHTML = isVideoOff ? '<i class="bi bi-camera-video-off-fill"></i>' : '<i class="bi bi-camera-video-fill"></i>';
      videoBtn.title = isVideoOff ? 'Turn On Video' : 'Turn Off Video';
      showToast(isVideoOff ? 'Video turned off' : 'Video turned on');
    }

    async function toggleScreenShare() {
      if (isScreenSharing) {
        await stopScreenShare();
      } else {
        await startScreenShare();
      }
    }

    async function startScreenShare() {
      try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({
          video: {
            width: { ideal: 1920 },
            height: { ideal: 1080 },
            frameRate: { ideal: 30 }
          },
          audio: false
        });
        
        // Replace video track in peer connection
        const videoTrack = screenStream.getVideoTracks()[0];
        const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
        
        if (sender) {
          await sender.replaceTrack(videoTrack);
        }
        
        // Show screen in local video
        localVideo.srcObject = screenStream;
        
        isScreenSharing = true;
        screenBtn.innerHTML = '<i class="bi bi-stop-fill"></i>';
        screenBtn.title = 'Stop Sharing';
        showToast('Screen sharing started');
        
        // Handle when user stops sharing
        videoTrack.onended = stopScreenShare;
        
      } catch (error) {
        console.error('Screen share error:', error);
        showToast('Screen sharing failed');
      }
    }

    async function stopScreenShare() {
      if (!screenStream || !localStream) return;
      
      // Replace with camera track
      const videoTrack = localStream.getVideoTracks()[0];
      const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
      
      if (sender) {
        await sender.replaceTrack(videoTrack);
      }
      
      // Stop screen tracks
      screenStream.getTracks().forEach(track => track.stop());
      screenStream = null;
      
      // Show camera in local video
      localVideo.srcObject = localStream;
      
      isScreenSharing = false;
      screenBtn.innerHTML = '<i class="bi bi-laptop"></i>';
      screenBtn.title = 'Share Screen';
      showToast('Screen sharing stopped');
    }

    function endCall() {
      if (peerConnection) {
        peerConnection.close();
      }
      
      if (currentRoomId) {
        database.ref(`calls/${currentRoomId}`).off();
        database.ref(`calls/${currentRoomId}`).remove();
      }
      
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      
      if (screenStream) {
        screenStream.getTracks().forEach(track => track.stop());
        screenStream = null;
      }
      
      remoteVideo.srcObject = null;
      localVideo.srcObject = null;
      
      updateStatus('Idle', 'status-idle');
      currentRoomId = '';
      isMuted = false;
      isVideoOff = false;
      isScreenSharing = false;
      
      // Reset buttons
      muteBtn.innerHTML = '<i class="bi bi-mic-fill"></i>';
      muteBtn.title = 'Mute';
      videoBtn.innerHTML = '<i class="bi bi-camera-video-fill"></i>';
      videoBtn.title = 'Turn Off Video';
      screenBtn.innerHTML = '<i class="bi bi-laptop"></i>';
      screenBtn.title = 'Share Screen';
      
      showToast('Call ended');
    }

    function cleanup() {
      endCall();
    }

    function updateStatus(text, statusClass) {
      statusText.textContent = text;
      
      // Remove all status classes
      statusDot.classList.remove(
        'status-idle', 'status-connecting', 'status-active', 'status-error'
      );
      
      // Add new status class
      if (statusClass) {
        statusDot.classList.add(statusClass);
      }
    }

    function showToast(message) {
      toastMessage.textContent = message;
      toast.show();
      
      // Auto hide after 3 seconds
      setTimeout(() => {
        toast.hide();
      }, 3000);
    }
  </script>
</body>
</html>